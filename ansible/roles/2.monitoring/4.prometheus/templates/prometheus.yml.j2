global:
  scrape_interval: 15s
  evaluation_interval: 15s

# Alertmanager configuration
alerting:
  alertmanagers:
  - static_configs:
    - targets: ['localhost:9093']

rule_files:
  - "rules.yml"
  # - "second_rules.yml"

scrape_configs:

  # Prometheus server itself
  - job_name: "prometheus"
    static_configs:
      - targets: ["localhost:9090"]

  # Kubernetes Service Discovery
  - job_name: 'kubernetes'
    kubernetes_sd_configs:
      - api_server: "https://{{ prometheus_server }}:6443" # Prometheus server variable
        role: service
        bearer_token: "{{ prometheus_token.stdout }}" # Token retrieved from Ansible
        tls_config:
          insecure_skip_verify: true
    relabel_configs:
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]
        action: replace
        target_label: __address__
        regex: (.+):(?:[0-9]+)
        replacement: $1:$2

  # Static configuration for Node.js app
  - job_name: 'nodejs-app-static'
    metrics_path: '/metrics'
    static_configs:
      - targets: ["{{ agent }}:3000"]
