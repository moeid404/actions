name: CD Pipeline

on:
  # workflow_run:
  #   workflows:
  #     - CI Pipeline
  #   types:
  #     - completed
  push:
    branches:
      - master
      - workflow_dispatch


jobs:
  deploy:
    # if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0

      - name: Terraform Apply
        id: terraform_apply
        run: |
          terraform init
          terraform apply -auto-approve
          terraform output -json > terraform-output.json
        working-directory: terraform

      - name: Debug Terraform Output File
        run: |
          cat terraform/terraform-output.json
      
      - name: Parse Terraform Outputs and Update Hosts File
        run: |
          # Define the file path
          HOSTS_FILE=ansible/hosts.ini
      
          # Extract IPs directly from Terraform
          AGENT_PUBLIC_IP=$(terraform output -raw agent_public_ip)
          PROMETHEUS_PUBLIC_IP=$(terraform output -raw prometheus_public_ip)
      
          # Debug outputs
          echo "Agent Public IP: $AGENT_PUBLIC_IP"
          echo "Prometheus Server IP: $PROMETHEUS_PUBLIC_IP"
      
          # Create or overwrite the hosts.ini file using echo
          echo "[agent]" > $HOSTS_FILE
          echo "$AGENT_PUBLIC_IP" >> $HOSTS_FILE
          echo "[prometheus_server]" >> $HOSTS_FILE
          echo "$PROMETHEUS_PUBLIC_IP" >> $HOSTS_FILE
          echo "[all:vars]" >> $HOSTS_FILE
          echo "ansible_user=ubuntu" >> $HOSTS_FILE
          working-directory: terraform
        

      - name: Add SSH Key
        run: |
          # Write the SSH private key from the GitHub Secret to the `ssh_key.pem` file
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ansible/ssh_key.pem
          chmod 600 ansible/ssh_key.pem
        shell: bash

      - name: Debug Hosts File
        run: cat ansible/hosts.ini
      
      - name: Run Ansible Playbook - Agent
        run: |
          ansible-playbook -i ansible/hosts.ini ansible/agent_play.yml --private-key ansible/ssh_key.pem
        env:
          ANSIBLE_HOST_KEY_CHECKING: "False"

      # - name: Run Ansible Playbook - Prometheus
      #   run: |
      #     ansible-playbook -i ansible/hosts.ini ansible/prometheus_play.yml --private-key ansible/ssh_key.pem
      #   env:
      #     ANSIBLE_HOST_KEY_CHECKING: "False"

      - name: Destroy Terraform Resources
        if: always() # Ensure this runs regardless of the job's success or failure
        run: |
          terraform destroy -auto-approve
        working-directory: terraform
